<?php

defined('BASEPATH') OR exit('No direct script access allowed');

class Deactivate extends Admin_Controller
{

        function __construct()
        {
                parent::__construct();
        }

        public function index($id = NULL)
        {
                $id = (int) $id;

                $this->load->library('form_validation');
                $this->form_validation->set_rules('confirm', $this->lang->line('deactivate_validation_confirm_label'), 'required');
                $this->form_validation->set_rules('id', $this->lang->line('deactivate_validation_user_id_label'), 'required|alpha_numeric');

                if ($this->form_validation->run() == FALSE)
                {
                        // insert csrf check
                        $this->data['csrf'] = $this->_get_csrf_nonce();
                        $this->data['user'] = $this->ion_auth->user($id)->row();

                        $this->header_view();
                        $this->_render_page('admin/deactivate_user', $this->data);
                        $this->_render_page('admin/footer');
                }
                else
                {
                        // do we really want to deactivate?
                        if ($this->input->post('confirm') == 'yes')
                        {
                                // do we have a valid request?
                                if ($this->_valid_csrf_nonce() === FALSE || $id != $this->input->post('id'))
                                {
                                        show_error($this->lang->line('error_csrf'));
                                }

                                // do we have the right userlevel?
                                if ($this->ion_auth->logged_in() && $this->ion_auth->is_admin())
                                {
                                        $this->ion_auth->deactivate($id);
                                }
                        }

                        // redirect them back to the user page
                        redirect('users', 'refresh');
                }
        }

}
